## Copyright 2017 Clemens Fruhwirth <clemens@endorphin.org>
##
## Usage: source master-zshrc from your .zshrc
##

#FIXME incorrect user selection when:
# pwdjail-mkdir /somedir/foo
# pwdjail-mkdir /somedir/foobar
# cd foobar
# This will select the foo user as /somedir/foo is a prefix of /somedir/foobar.

# FIXME any modification to this function with pwdjail-rm-Ir
function pwdjail_get_user_for_directory() {
  getent passwd | awk -F: '"'"$1"/'" ~ $6"/" && $5 ~ "Sandbox user" { print $1 }' | head -1
}

function pwdjail_enter() {
    # Grab through /etc/passwd for sandbox users that have a home dir above $PWD.
    SANDBOX_USER=$(pwdjail_get_user_for_directory "$PWD")
    [ -z "$SANDBOX_USER" ] && return

    TMP=$(mktemp)
    # FIXME Don't make that world-write readable.
    chmod a+w $TMP

    sudo -u $SANDBOX_USER /usr/bin/env PWDJAIL_EXIT_DIR=$TMP zsh -i
    EXIT_DIR=$(cat $TMP)
    rm $TMP
    if [ -z "$EXIT_DIR" ]; then
        echo 'Warning: Sandbox shell exited without changing directory. Use "cd" to exit.'
        echo 'You are in a sandbox directory now.'
    else
        cd $EXIT_DIR
    fi
}

chpwd_functions=(${chpwd_functions[@]} "pwdjail_enter")
